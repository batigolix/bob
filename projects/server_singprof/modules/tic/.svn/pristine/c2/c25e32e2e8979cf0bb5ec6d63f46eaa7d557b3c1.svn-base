<?php
/**
 * @file
 * Main bootstrap file of the tic module.
 */


/**
 * Implements hook_menu().
 *
 */
function tic_menu() {
  $menu = array();

  $menu['tic/test'] = array(
    'title' => 'TIC test stuff',
    'description' => 'Test tic stuff and such',
    'page callback' => 'tic_test_stuff',
    'access arguments' => array('access administration pages'),
    'file' => 'tic.pages.inc',
    'type' => MENU_LOCAL_TASK,
    'weight' => 0,
  );
  $menu['tic/test2'] = array(
    'title' => 'TIC test stuff',
    'page callback' => 'tic_test_stuff2',
    'access arguments' => array('access administration pages'),
    'file' => 'tic.pages.inc',
    'type' => MENU_LOCAL_TASK,
    'weight' => 0,
  );
  $menu['tic/test3'] = array(
    'title' => 'TIC test stuff',
    'page callback' => 'tic_test_stuff3',
    'access arguments' => array('access administration pages'),
    'file' => 'tic.pages.inc',
    'type' => MENU_LOCAL_TASK,
    'weight' => 0,
  );
  $menu['tic/test4'] = array(
    'title' => 'TIC test stuff',
    'page callback' => 'tic_test_stuff4',
    'access arguments' => array('access administration pages'),
    'file' => 'tic.pages.inc',
    'type' => MENU_LOCAL_TASK,
    'weight' => 0,
  );

  return $menu;
}

function XXXXtic_init() {
  drupal_add_js('https://ec.europa.eu/wel/surveys/wr_survey01/wr_survey.js', array(
  'type' => 'external',
  'scope' => 'header',
  'group' => JS_THEME,
  'every_page' => TRUE,
  'weight' => -99,
));
}
/*

function tic_url_outbound_alter(&$path, &$options, $original_path) {
  
  dsm('abc');
  
  if (preg_match('|^taxonomy/term/([0-9]*)|', $path, $matches)) {
    // Alter $path; $matches[1] contains the term ID.
  }
}

function tic_url_inbound_alter(&$path, $original_path, $path_language) {
  dsm($path);
  dsm('xyz');
  // Revert the change done in mymodule_url_outbound_alter().
  
  if (preg_match('|^taxonomy/term/([0-9]*)|', $path, $matches)) {
    // Alter $path; $matches[1] contains the term ID.
  }
  
  
}

 */


/** 
 * * Implementation of hook_menu_alter(). 
 */
function XXXtic_menu_alter(&$menu) {
  print('ticssssdfsdf');
    dsm('ticdddyipaaSS');
    drupal_set_message('ticsadsadv');
    dpm($menu);
  if (isset($menu['taxonomy/term/%'])) {
    dsm('yipaa');
    $menu['taxonomy/term/%']['page callback'] = 'connect_country_taxonomy_term_page';
//    $menu['taxonomy/term/%']['access callback'] = 'mymodule_access_term_pages';
//    $menu['taxonomy/term/%']['access arguments'] = array(2);
    $menu['taxonomy/term/%']['file'] = 'connect_country.pages.inc';
  }
}


function XXXtic_module_implements_alter(&$implementations, $hook) {
  if ($hook == 'menu_alter') {
    $group = $implementations['tic'];
    unset($implementations['tic']);
    $implementations['tic'] = $group;
  }
}

//$modules = module_list($refresh = FALSE, $bootstrap_refresh = FALSE, $sort = FALSE, $fixed_list = NULL);
//dpm($modules);

function XXXtic_preprocess_node(&$vars) {
  dpm($vars);
//  
dsm($vars['created']);
dsm(format_date($vars['created'], 'custom', 'Y-m-d H:i:s O'));
//  dsm(format_date($vars['changed'], 'custom', 'Y-m-d H:i:s O'));
//  dsm(format_date($vars['revision_timestamp'], 'custom', 'Y-m-d H:i:s O'));
//  dsm(format_date($vars['workbench_moderation']['current']->timestamp, 'custom', 'Y-m-d H:i:s O'));
  //dpm($vars['workbench_moderation']['current']->published);
  //workbench_moderation 
  
  $query = db_select('workbench_moderation_node_history', 'wmnh');
  $query->condition('wmnh.nid', $vars['nid']);
  $query->condition('wmnh.state', 'published');
  $query->addField('wmnh', 'stamp', 'publication_date');
  $query->orderBy('wmnh.stamp', 'ASC');
  $results = $query->execute();
  $publication_date = $results->fetchField();

  dsm($publication_date);
  dsm(format_date($publication_date, 'custom', 'Y-m-d H:i:s O'));
  
}

//
//function tic_quicktabs_alter($quicktabs) {
//  dpm($quicktabs);
//  foreach($quicktabs->tabs as $tab) {
//    if (!empty($tab['bid'])) {
////      $block = block_custom_block_get($tab['bid']);
//      $bid = explode('_delta_', $tab['bid']);
//      $module = $bid[0];
//      $delta = $bid[1];
//      $block = block_load($module, $delta);
//dpm($block);
//      
//    }
//  }
//}
<?php

/**
 * @file tic.module
 * TODO: Enter file description here.
 */

/**
 * Implements hook_menu().
 */
function tic_menu() {
  $items['tic/example'] = array(
    'title' => 'Example interaction with service',
    'page callback' => 'tic_test1',
    'access arguments' => array('access content'),
    'type' => MENU_SUGGESTED_ITEM,
  );

  return $items;
}

/**
 * Create a token for non-safe REST calls.
 * */
function tic_get_csrf_header() {
  $curl_get = curl_init();
  curl_setopt_array($curl_get, array(
    CURLOPT_RETURNTRANSFER => 1,
    CURLOPT_URL => 'http://server.singprof.val/services/session/token',
  ));
  $csrf_token = curl_exec($curl_get);
  curl_close($curl_get);
  return 'X-CSRF-Token: ' . $csrf_token;
}

function tic_test1() {

  /* GET USER */
  $get_user_result = tic_get_user(1);
  dpm($get_user_result);
  $data = json_decode($get_user_result->data);
  dpm($data);

  
  $get_tt_result = tic_get_taxonomy_term(42);
  dpm($get_tt_result);
  $data = json_decode($get_tt_result->data);
  dpm($data);
  
  
  /* UPDATE USER */
//  $get_user_result = tic_update_user();
//  dpm($get_user_result);
//  $data = json_decode($get_user_result->data);
//  dpm($data);
  // /* UPDATE NODE */
//  $update_node_result = tic_update_node();
//  dpm($update_node_result);
//  $data = json_decode($update_node_result->data);
//  dpm($data);
//
//
//  /* GET NODE */
//  $get_node_result = tic_get_node();
//  dpm($get_node_result);
//  $data = json_decode($get_node_result->data);
//  dpm($data);
//  $wrpuser = entity_metadata_wrapper('user', $data[0]);
//  
//  dsm($wrpuser->field_first_name->value());
//tic_get_articles

  /* GET BLOGS */
//  $get_blogs_result = tic_get_articles();
//  dpm($get_blogs_result);
//  $data = json_decode($get_blogs_result->data);
//  dpm($data);

  $build = array();
  $build['test']['#markup'] = 'test';
  return $build;
}

/**
 * @file
 * Web Services Testing
 */
function tic_block_info() {
  $blocks['tic'] = array('info' => t('Web Services Testing'));
  return $blocks;
}

function tic_block_view($delta = '') {
  $block['content'] = '<h1>Web Services Testing</h1>';

  /* GET NODE */
  $get_node_result = tic_get_node();
  dpm($get_node_result);
  $data = json_decode($get_node_result->data);
  dpm($data);

  // /* CREATE NODE */
  $create_node_result = tic_create_node();
  dpm($create_node_result);

  // /* UPDATE NODE */
  $update_node_result = tic_update_node();
  dpm($update_node_result);

  /* DELETE NODE */
  // $delete_node_result = tic_delete_node();
  // dpm($delete_node_result);

  return $block;
}

/* RETRIVE node with http GET method */

function tic_get_node() {
  $url = 'http://server.singprof.val/test/node/2';
//  $parameters = '?parameters[nid]=2';
//  $url .= $parameters;
  return drupal_http_request($url);
}

function tic_get_taxonomy_term($tid) {
  if (isset($tid)) {
    $url = 'http://server.singprof.val/test/entity_taxonomy_term/' . $tid;
    // $parameters = '?parameters[nid]=2';
    // $url .= $parameters;
    return drupal_http_request($url);
  }
  else {
    
  }
}

/* RETRIVE user with http GET method */

function tic_get_user($uid) {
  $url = 'http://server.singprof.val/test/user/'.$uid;
//  $parameters = '?parameters[uid]=3'; // TODO figure out how/if to use parameters
//  $url .= $parameters;

  $login_data = tic_login('admin', 'letmein');

  //dpm($login_data);

  $user_options = array(
    'headers' => array(
      'Content-Type' => 'application/json',
      'Cookie' => $login_data['cookie'],
      'X-CSRF-Token' => $login_data['token'],
    ),
    'method' => 'GET',
//		'data' => $node_data,
  );
  return drupal_http_request($url, $user_options);
}

/* RETRIVE user with http GET method */

function tic_get_articles() {
  $url = 'http://server.singprof.val/test/blogs/retrieve';
  $parameters = '?nitems=3&since=10';
  $url .= $parameters;

  $login_data = tic_login('admin', 'letmein');

  //dpm($login_data);

  $user_options = array(
    'headers' => array(
      'Content-Type' => 'application/json',
      'Cookie' => $login_data['cookie'],
      'X-CSRF-Token' => $login_data['token'],
    ),
    'method' => 'GET',
//		'data' => $node_data,
  );
  return drupal_http_request($url, $user_options);
}

/* CREATE node with http POST method */

function tic_create_node() {
  $url = 'http://server.singprof.val/test/node';

  $node_type = 'article';
  $node_title = 'Node updated: ' . date('c');
  $node_body = 'Node body';
  $node_format = 'filtered_html';

  $node_data = '{
		"type" : "' . $node_type . '",
		"title" : "' . $node_title . '",
		"body" : {
			"und" : {
				"0" : {
					"value" : "' . $node_body . '",
					"format" : "' . $node_format . '"
				}
			}
		}
	}';


  $login_data = tic_login('admin', 'letmein');

  //dpm($login_data);

  $node_options = array(
    'headers' => array(
      'Content-Type' => 'application/json',
      'Cookie' => $login_data['cookie'],
      'X-CSRF-Token' => $login_data['token'],
    ),
    'method' => 'POST',
    'data' => $node_data,
  );


  return drupal_http_request($url, $node_options);
}

/* UPDATE node with http PUT method */

function tic_update_node() {

  $node_nid = 2;
  $url = 'http://server.singprof.val/test/node/' . $node_nid;

  $node_data = array(
    'type' => 'article',
    'title' => 'Nodezz updated: ' . date('c'),
    'body' => array(
      'value' => 'test bod',
      'format' => 'plain_text',
    )
  );


  $snode_data = '{
		"type" : "article",
		"title" : "test",
		"body" :  {
					"value" : "test bod",
					"format" : "text"
			
		}
	}';

  $login_data = tic_login('admin', 'letmein');

  $node_options = array(
    'headers' => array(
      'Content-Type' => 'application/json',
      'Cookie' => $login_data['cookie'],
      'X-CSRF-Token' => $login_data['token'],
    ),
    'method' => 'PUT',
    //'data' => $node_data,
    'data' => json_encode($node_data),
  );


  return drupal_http_request($url, $node_options);
}

/* UPDATE node with http PUT method */

function tic_update_user() {

  $uid = 3;
  $url = 'http://server.singprof.val/test/user/' . $uid;

  $user_data = array(
    'name' => 'john2',
    'mail' => 'hallo2@hallo.nl',
    'first_name' => 'Jimboke',
  );

  $login_data = tic_login('admin', 'letmein');

  $user_options = array(
    'headers' => array(
      'Content-Type' => 'application/json',
      'Cookie' => $login_data['cookie'],
      'X-CSRF-Token' => $login_data['token'],
    ),
    'method' => 'PUT',
    'data' => json_encode($user_data),
  );


  return drupal_http_request($url, $user_options);
}

/* DELETE node with http DELETE method */

function tic_delete_node() {

  $node_nid = 3;
  $url = 'http://server.singprof.val/test/node/' . $node_nid;

  $login_data = tic_login('admin', 'admin');

  $node_options = array(
    'headers' => array(
      'Content-Type' => 'application/json',
      'Cookie' => $login_data['cookie'],
      'X-CSRF-Token' => $login_data['token'],
    ),
    'method' => 'DELETE'
  );


  return drupal_http_request($url, $node_options);
}

/* LOGIN with POST method */

function tic_login($username, $password) {

  if (isset($_COOKIE['drupal_session_name']) && isset($_COOKIE['drupal_session_id']) && isset($_COOKIE['drupal_session_token'])) {
    $cookie = '' . $_COOKIE['drupal_session_name'] . '=' . $_COOKIE['drupal_session_id'] . '';
    return array('cookie' => $cookie, 'token' => $_COOKIE['drupal_session_token']);
    //return '' . $_COOKIE['drupal_session_name'] . '=' . $_COOKIE['drupal_session_id'] . '';
  }
  else {
    $login_url = 'http://server.singprof.val/test/user/login';

    $user_data = '{
			"username" : "' . $username . '",
			"password" : "' . $password . '"
		}';

    $user_options = array(
      'headers' => array(
        'Content-Type' => 'application/json'),
      'method' => 'POST',
      'data' => $user_data
    );
  };

  $result = drupal_http_request($login_url, $user_options);


  if ($result->code == 200) {
    $user_data = json_decode($result->data);

    setcookie('drupal_session_name', $user_data->session_name);
    setcookie('drupal_session_id', $user_data->sessid);

    $cookie = '' . $user_data->session_name . '=' . $user_data->sessid . '';

    $token_options = array(
      'headers' => array(
        'Cookie' => $cookie,
      ),
      'method' => 'GET',
    );

    $token = drupal_http_request('http://server.singprof.val/services/session/token', $token_options);

    setcookie('drupal_session_token', $token->data);

    return array('cookie' => $cookie, 'token' => $token->data);
    //return '' . $user_data->session_name . '=' . $user_data->sessid . '';
  }
  else
    return FALSE;
}
